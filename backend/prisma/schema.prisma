// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Curso {
  IDCurso     String   @id @default(uuid())
  NomeDoCurso String
  Descricao   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  disciplinas Disciplina[]
  alunos      Aluno[]

  @@map("cursos")
}

model Disciplina {
  IDDisciplina       String   @id @default(uuid())
  IDCurso            String
  NomeDaDisciplina   String
  CodigoDaDisciplina String?
  Ativa              Boolean  @default(true)
  CargaHoraria       Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relacionamentos
  curso      Curso       @relation(fields: [IDCurso], references: [IDCurso], onDelete: Cascade)
  matriculas Matricula[]

  // Índices e constraints
  @@unique([IDCurso, CodigoDaDisciplina])
  @@map("disciplinas")
}

model Aluno {
  IDAluno   String   @id @default(uuid())
  Nome      String
  Email     String   @unique
  Idade     Int?
  IDCurso   String
  IDUser    String   @unique // Campo obrigatório para referenciar User
  Semestre  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  curso      Curso         @relation(fields: [IDCurso], references: [IDCurso], onDelete: Cascade)
  matriculas Matricula[]
  user       User          @relation(fields: [IDUser], references: [IDUser], onDelete: Cascade)
  habitos AlunoHabito[]

  @@map("alunos")
}

model AlunoHabito {
  IDHabito    String   @id @default(uuid())
  IDAluno     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Campos básicos de hábitos (mantidos para compatibilidade)
  horasEstudo Float?  // Horas de estudo semanais (0-84 = até ~12h por dia)
  sono        Float?  // Horas de sono por dia (0-12)
  motivacao   Int?    // Nível de motivação (0-10) - mantido como Int para compatibilidade
  frequencia  Float?  // Frequência/Attendance em percentual (0-100)

  // Campos para predição de EVASÃO
  raisedhands            Int?    // Quantidade de vezes que levantou a mão
  VisITedResources       Int?    // Quantidade de recursos visitados
  AnnouncementsView      Int?   // Quantidade de anúncios visualizados
  Discussion             Int?    // Participações em discussões
  ParentAnsweringSurvey  String? // Pais responderam pesquisa: "Yes" ou "No"
  ParentschoolSatisfaction String? // Satisfação dos pais: "Good" ou "Bad"
  StudentAbsenceDays     String? // Faltas: "Under-7" ou "Above-7"

  // Campos para predição de DESEMPENHO
  Previous_Scores        Float?  // Notas anteriores
  Distance_from_Home     String? // Distância de casa: "Near" ou "Far"
  Gender                 String? // Gênero: "Male" ou "Female"
  Parental_Education_Level String? // Nível educacional dos pais: "None", "High School", "Some College", "Bachelor's", "Master's"
  Parental_Involvement   String? // Envolvimento dos pais: "Low", "Medium", "High"
  School_Type            String? // Tipo de escola: "Public" ou "Private"
  Peer_Influence         String? // Influência dos pares: "Positive", "Negative", "Neutral"
  Extracurricular_Activities String? // Atividades extracurriculares: "Yes" ou "No"
  Learning_Disabilities  String? // Deficiências de aprendizagem: "Yes" ou "No"
  Internet_Access        String? // Acesso à internet: "Yes" ou "No"
  Access_to_Resources    String? // Acesso a recursos: "Poor", "Average", "Good"
  Teacher_Quality        String? // Qualidade do professor: "Poor", "Average", "Good"
  Family_Income           String? // Renda familiar: "Low", "Medium", "High"
  Motivation_Level       String? // Nível de motivação: "Low", "Medium", "High"
  Tutoring_Sessions      String? // Sessões de tutoria: "Yes" ou "No"
  Physical_Activity      String? // Atividade física: "Low", "Medium", "High"

  aluno Aluno @relation(fields: [IDAluno], references: [IDAluno], onDelete: Cascade)

  @@map("aluno_habitos")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum PasswordResetStatus {
  PENDING
  USED
  EXPIRED
}

model User {
  IDUser       String   @id @default(uuid())
  Email        String   @unique
  PasswordHash String
  Role         UserRole @default(STUDENT)
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamento um-para-muitos com Aluno
  alunos        Aluno[]
  resetRequests PasswordResetRequest[]
  notificacoes  Notificacao[]

  @@map("users")
}

model PasswordResetRequest {
  id          String              @id @default(uuid())
  userId      String
  otpHash     String
  expiresAt   DateTime
  attempts    Int                 @default(0)
  status      PasswordResetStatus @default(PENDING)
  requestedAt DateTime            @default(now())
  ipAddress   String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  user User @relation(fields: [userId], references: [IDUser], onDelete: Cascade)

  @@index([userId, requestedAt])
  @@map("password_reset_requests")
}

model PeriodoLetivo {
  IDPeriodo  String   @id @default(uuid())
  Nome       String
  DataInicio DateTime
  DataFim    DateTime
  Ativo      Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  matriculas Matricula[]

  @@index([Ativo], name: "idx_periodos_letivos_ativo")
  @@map("periodos_letivos")
}

enum StatusMatricula {
  ENROLLED
  DROPPED
  COMPLETED
}

model Matricula {
  IDMatricula  String          @id @default(uuid())
  IDAluno      String
  IDDisciplina String
  IDPeriodo    String
  Status       StatusMatricula @default(ENROLLED)
  Nota         Float? // Nota do aluno na disciplina (pode ser calculada a partir das notas individuais)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relacionamentos
  aluno       Aluno         @relation(fields: [IDAluno], references: [IDAluno], onDelete: Cascade)
  disciplina  Disciplina    @relation(fields: [IDDisciplina], references: [IDDisciplina], onDelete: Cascade)
  periodo     PeriodoLetivo @relation(fields: [IDPeriodo], references: [IDPeriodo], onDelete: Cascade)
  predictions Prediction[]
  notas       Nota[]
  desempenhos Desempenho[]

  // Constraint única
  @@unique([IDAluno, IDDisciplina, IDPeriodo])
  // Índices para acelerar "alunos por disciplina/período"
  @@index([IDDisciplina, IDPeriodo], name: "idx_matriculas_disciplina_periodo")
  @@index([IDAluno], name: "idx_matriculas_aluno")
  @@map("matriculas")
}

enum TipoPredicao {
  DESEMPENHO
  EVASAO
}

model Prediction {
  IDPrediction  String       @id @default(uuid())
  IDMatricula   String
  TipoPredicao  TipoPredicao
  Probabilidade Float // Probabilidade da predição (0-1)
  Classificacao String // Classificação (ex: "baixo", "médio", "alto", "aprovado", "reprovado")
  Explicacao    String? // Explicação da predição
  DadosEntrada  Json? // Dados utilizados para a predição
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relacionamentos
  matricula Matricula @relation(fields: [IDMatricula], references: [IDMatricula], onDelete: Cascade)
  desempenho Desempenho?

  // Índice para pegar "a última predição por matrícula e tipo"
  @@index([IDMatricula, TipoPredicao, createdAt], name: "idx_predictions_matricula_tipo_created")
  @@map("predictions")
}

model Nota {
  IDNota        String   @id @default(uuid())
  IDMatricula   String
  Valor         Float    // Valor da nota (0-10 ou 0-100)
  Tipo          String?  // Tipo de avaliação: "P1", "P2", "Trabalho", "Prova Final", "Atividade", etc.
  DataAvaliacao DateTime @default(now()) // Data em que a nota foi atribuída
  Observacoes    String?  // Observações sobre a nota
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  matricula Matricula @relation(fields: [IDMatricula], references: [IDMatricula], onDelete: Cascade)

  // Índices
  @@index([IDMatricula], name: "idx_notas_matricula")
  @@index([IDMatricula, DataAvaliacao], name: "idx_notas_matricula_data")
  @@map("notas")
}

model Desempenho {
  IDDesempenho  String   @id @default(uuid())
  IDMatricula   String
  IDPrediction  String?  @unique // Relaciona com a Prediction que gerou este desempenho
  NotaPrevista  Float    // Nota prevista pelo algoritmo (0-10)
  NotaPercentual Float   // Nota em percentual (0-100)
  Classificacao String   // Classificação: "baixo", "médio", "alto", "insuficiente", "suficiente", etc.
  Probabilidade Float    // Probabilidade de aprovação (0-1)
  StatusAprovacao String? // Status de aprovação: "aprovado", "reprovado", "em risco"
  CategoriaNota  String? // Categoria da nota: "INSUFICIENTE", "SUFICIENTE", "BOM", "MUITO_BOM", "EXCELENTE"
  Observacoes    String? // Observações adicionais sobre o desempenho
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  matricula Matricula @relation(fields: [IDMatricula], references: [IDMatricula], onDelete: Cascade)
  prediction Prediction? @relation(fields: [IDPrediction], references: [IDPrediction], onDelete: SetNull)

  // Índices para consultas otimizadas
  @@index([IDMatricula], name: "idx_desempenho_matricula")
  @@index([IDMatricula, createdAt], name: "idx_desempenho_matricula_data")
  @@index([IDPrediction], name: "idx_desempenho_prediction")
  @@map("desempenhos")
}

enum TipoNotificacao {
  DESEMPENHO
  EVASAO
  NOTA
  SISTEMA
  ALERTA
}

enum StatusNotificacao {
  NAO_LIDA
  LIDA
  ARQUIVADA
}

model Notificacao {
  IDNotificacao  String            @id @default(uuid())
  IDUser         String
  Tipo           TipoNotificacao
  Titulo         String
  Mensagem       String
  Status         StatusNotificacao @default(NAO_LIDA)
  Link           String?           // Link opcional para navegação (ex: "/alunos/123")
  DadosAdicionais Json?            // Dados extras em JSON (ex: IDMatricula, IDPrediction)
  createdAt      DateTime          @default(now())
  lidaEm         DateTime?         // Data em que foi marcada como lida
  updatedAt      DateTime          @updatedAt

  // Relacionamentos
  user User @relation(fields: [IDUser], references: [IDUser], onDelete: Cascade)

  // Índices para consultas otimizadas
  @@index([IDUser, Status], name: "idx_notificacoes_user_status")
  @@index([IDUser, createdAt], name: "idx_notificacoes_user_data")
  @@index([Status], name: "idx_notificacoes_status")
  @@map("notificacoes")
}